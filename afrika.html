<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MİLİTAN ATLASI AJSKHD</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      background: #111;
      color: #eee;
      height: 100vh;
      overflow: hidden;
    }
    #container { display: flex; height: 100%; }
    #map-area {
      flex: 1;
      position: relative;
      background: #1a1a1a;
      overflow: hidden;
      cursor: default;
    }
    svg {
      width: 100%;
      height: 100%;
      display: block;
      user-select: none;
      touch-action: manipulation;
    }
    svg path {
      fill: #ffffff;
      stroke: #000000;
      stroke-width: 2.0;
      vector-effect: non-scaling-stroke;
      pointer-events: all;
      transition: fill 0.25s, stroke 0.25s;
    }
    svg path:hover {
      fill: #4ade80 !important;
      stroke: #000;
      stroke-width: 2.5;
    }
    svg path.active {
      fill: #ff4444 !important;
      stroke: #000;
      stroke-width: 3.0;
    }
    svg path.highlight-red {
      fill: #c62828 !important;
      stroke: #fff !important;
      stroke-width: 2.8;
    }
    svg path.highlight-red:hover {
      fill: #e53935 !important;
    }

    .tooltip {
      position: absolute;
      background: rgba(0,0,0,0.92);
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13.5px;
      pointer-events: none;
      z-index: 100;
      max-width: 280px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.7);
      display: none;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .tooltip.visible { display: block; }
    .tooltip strong {
      display: block;
      font-size: 16px;
      margin-bottom: 6px;
      color: #4ade80;
    }

    #sidebar {
      width: 340px;
      background: #1f1f1f;
      border-left: 1px solid #333;
      color: #ddd;
      padding: 20px;
      position: relative;
      overflow-y: auto;
      display: none;
      transition: transform 0.45s cubic-bezier(0.32, 0.72, 0, 1);
      transform: translateX(100%);
      box-shadow: -10px 0 30px rgba(0,0,0,0.6);
      z-index: 300;
    }
    #sidebar.active { display: block; transform: translateX(0); }

    #sidebar-close {
      position: absolute;
      top: 12px; right: 12px;
      width: 28px; height: 28px;
      background: #444;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 20px;
      line-height: 26px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      z-index: 310;
    }
    #sidebar-close:hover { background: #666; transform: scale(1.08); }

    #mode-buttons { margin: 0 0 24px 0; }
    .mode-button {
      display: block;
      width: 100%;
      padding: 14px 16px;
      margin: 10px 0;
      background: #2a2a2a;
      border: 1px solid #444;
      color: #ddd;
      font-size: 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.22s;
      text-align: center;
      font-weight: 500;
    }
    .mode-button:hover { background: #333; }
    .mode-button.active {
      background: #4ade80;
      color: #111;
      border-color: #4ade80;
      font-weight: bold;
    }

    #search-container { margin-bottom: 18px; position: relative; z-index: 305; }
    #search-input {
      width: 100%;
      padding: 12px 40px 12px 14px;
      background: #2a2a2a;
      border: 1px solid #444;
      color: white;
      border-radius: 8px;
      font-size: 15px;
    }
    #search-input::placeholder { color: #888; }
    #clear-search {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #888;
      font-size: 20px;
      cursor: pointer;
      display: none;
    }

    .suggestion-item {
      padding: 14px 16px;
      background: #2a2a2a;
      margin: 8px 0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 4px solid #4ade80;
    }
    .suggestion-item:hover {
      background: #333;
      transform: translateX(4px);
      box-shadow: 0 3px 12px rgba(74,222,128,0.15);
    }

    #menu-button {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 72px;
      height: 72px;
      background: #4ade80;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 8px 25px rgba(74,222,128,0.6);
      z-index: 150;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #menu-button:hover { transform: scale(1.15); background: #66ff99; }
    #menu-button.hidden { opacity: 0; pointer-events: none; transform: scale(0.6); }

    #sidebar-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 250;
      opacity: 0;
      transition: opacity 0.4s;
      backdrop-filter: blur(5px);
      pointer-events: none;
    }

    /* MODAL STİLLER */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 400;
      backdrop-filter: blur(6px);
    }
    .modal.active { display: flex; }

    .modal-content {
      background: #1f1f1f;
      border: 1px solid #444;
      border-radius: 12px;
      width: 90%;
      max-width: 480px;
      padding: 28px;
      position: relative;
      box-shadow: 0 15px 40px rgba(0,0,0,0.7);
      color: #eee;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-close, .modal-back {
      position: absolute;
      top: 16px;
      background: #333;
      color: #ccc;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 24px;
      line-height: 32px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .modal-close { right: 20px; }
    .modal-back { left: 20px; }

    .modal-close:hover, .modal-back:hover {
      background: #555;
      color: white;
      transform: scale(1.1);
    }

    .modal h2 {
      margin: 0 0 24px 0;
      color: #4ade80;
      padding-left: 50px;
    }

    #country-groups .group-item {
      margin: 12px 0;
      background: #2a2a2a;
      padding: 16px;
      border-radius: 10px;
      border-left: 5px solid #4ade80;
      cursor: pointer;
    }

    /* Sekmeler */
    .tabs {
      display: flex;
      border-bottom: 1px solid #444;
      margin: 20px 0 16px;
      overflow-x: auto;
      gap: 6px;
      padding-bottom: 4px;
    }
    .tab {
      padding: 10px 20px;
      background: #2a2a2a;
      border: 1px solid #444;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }
    .tab.active {
      background: #3a3a3a;
      color: #4ade80;
      border-color: #4ade80;
    }

    .tab-content { padding: 16px; }

    @media (max-width: 768px) {
      #container { flex-direction: column; }
      #map-area { flex: 1 1 60%; }
      #sidebar {
        width: 100%;
        height: auto;
        max-height: 65%;
        position: fixed;
        bottom: 0; left: 0; right: 0;
        transform: translateY(100%);
        border-top: 1px solid #444;
      }
      #sidebar.active { transform: translateY(0); }
      #menu-button { bottom: 90px; right: 24px; }
    }
  </style>
</head>
<body>

<div id="container">
  <a href="https://militantatlas-droid.github.io/militantatlascom" id="back-to-home" title="Ana sayfaya dön">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
    </svg>
  </a>

  <div id="map-area">
    <svg id="svg-map" viewBox="0 0 1000 1000" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
      <!-- SVG path'lerin tamamı buraya gelecek - senin orijinal dosyanın path kısmını buraya kopyala -->
      <path id="AO" data-name="Angola" d="..."></path>
      <path id="BI" data-name="Burundi" d="..."></path>
      <!-- ... diğer ülkelerin path'leri ... -->
      <!-- Senin orijinal dosyandaki <svg> içindeki tüm <path> etiketlerini buraya yapıştır -->
    </svg>
  </div>

  <!-- Sidebar -->
  <div id="sidebar">
    <button id="sidebar-close">×</button>

    <div id="mode-buttons">
      <button class="mode-button active" data-mode="country">ÜLKE ARA</button>
      <button class="mode-button" data-mode="group">GRUP ARA</button>
      <button class="mode-button" data-mode="map-by-group">GRUPLARIN FAAL OLDUKLARI ÜLKELER</button>
    </div>

    <div id="search-container">
      <input type="text" id="search-input" placeholder="Ülke ara...">
      <button id="clear-search">×</button>
    </div>

    <div id="sidebar-content"></div>
  </div>

  <!-- Menü butonu (hamburger) -->
  <button id="menu-button" title="Menüyü aç">
    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="3">
      <line x1="3" y1="6" x2="21" y2="6"/>
      <line x1="3" y1="12" x2="21" y2="12"/>
      <line x1="3" y1="18" x2="21" y2="18"/>
    </svg>
  </button>

  <!-- Tooltip -->
  <div id="tooltip" class="tooltip"></div>

  <!-- Ülke Modal -->
  <div id="country-modal" class="modal">
    <div class="modal-content">
      <button class="modal-close" id="country-modal-close">×</button>
      <h2 id="country-modal-title">Ülke</h2>
      <div id="country-groups"></div>
    </div>
  </div>

  <!-- Grup Detay Modal -->
  <div id="group-detail-modal" class="modal">
    <div class="modal-content">
      <button class="modal-back" id="group-detail-back">←</button>
      <button class="modal-close" id="group-detail-close">×</button>
      <h2 id="group-detail-title">Grup</h2>
      <div class="tabs">
        <div class="tab active" data-tab="temel">Temel Bilgiler</div>
        <div class="tab" data-tab="durum">Durum</div>
        <div class="tab" data-tab="detay">Detay</div>
      </div>
      <div id="tab-content" class="tab-content"></div>
    </div>
  </div>

  <!-- Büyük Detay Modal (örnek placeholder - içeriği sen doldurabilirsin) -->
  <div id="long-detail-modal" class="modal">
    <div class="modal-content" style="max-width:1100px;">
      <button class="modal-close" id="long-detail-close">×</button>
      <h2 id="long-detail-title">Detaylı Bilgi</h2>
      <p style="text-align:center; padding:80px 0; color:#888;">Detaylı içerik burada görünecek (JSON'dan çekilebilir)</p>
    </div>
  </div>

</div>

<script>
let countryData = {};
let activePath = null;
let currentCountryId = null;
let currentGroup = null;
let currentMode = "country";

const tooltip        = document.getElementById("tooltip");
const mapArea        = document.getElementById("map-area");
const sidebar        = document.getElementById("sidebar");
const searchInput    = document.getElementById("search-input");
const clearSearch    = document.getElementById("clear-search");
const sidebarContent = document.getElementById("sidebar-content");
const menuButton     = document.getElementById("menu-button");
const modeButtons    = document.querySelectorAll(".mode-button");

// JSON yükleme
fetch("trdata.json")
  .then(res => res.json())
  .then(data => {
    countryData = data;
    initMap();
  })
  .catch(err => {
    console.error("JSON yüklenemedi:", err);
    sidebarContent.innerHTML = `<p style="color:#ff4444; font-weight:bold; text-align:center; padding:30px;">Veri dosyası yüklenemedi.</p>`;
    initMap();
  });

function initMap() {
  document.querySelectorAll("svg path").forEach(path => {
    const id = path.id;
    if (!id) return;
    const fallbackName = path.getAttribute("data-name") || id || "Bilinmeyen";

    path.addEventListener("mouseover", e => {
      const country = countryData[id] || {};
      const name = country.name_tr || fallbackName;
      const groups = country.groups?.length 
        ? country.groups.map(g => g.name_tr || "Bilinmeyen").join("<br>")
        : "Grup bilgisi yok";
      tooltip.innerHTML = `<strong>${name}</strong><br>${groups}`;
      tooltip.classList.add("visible");
      moveTooltip(e);
    });

    path.addEventListener("mousemove", moveTooltip);
    path.addEventListener("mouseout", () => tooltip.classList.remove("visible"));

    path.addEventListener("click", e => {
      e.stopPropagation();
      activateCountry(id, fallbackName, path);
    });

    path.addEventListener("touchend", e => {
      e.preventDefault();
      e.stopPropagation();
      activateCountry(id, fallbackName, path);
    }, { passive: false });
  });

  // Mod değiştirme
  modeButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      modeButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      currentMode = btn.dataset.mode;

      const ph = {
        country: "Ülke ara... (ör: Nijerya, Mali)",
        group: "Grup ara... (ör: IŞİD, JNIM, Boko)",
        "map-by-group": "Grup yaz... (ülkeler kırmızı olur)"
      };
      searchInput.placeholder = ph[currentMode] || "Ara...";

      searchInput.value = "";
      searchInput.dispatchEvent(new Event("input"));
      clearCountryHighlights();
    });
  });

  searchInput.addEventListener("input", () => {
    const term = searchInput.value.trim().toLowerCase();
    clearSearch.style.display = term ? "block" : "none";

    if (!term) {
      sidebarContent.innerHTML = "";
      if (currentMode === "map-by-group") clearCountryHighlights();
      return;
    }

    if (currentMode === "country") showCountrySuggestions(term);
    else if (currentMode === "group") showGroupSuggestions(term);
    else if (currentMode === "map-by-group") showMapByGroupSuggestions(term);
  });

  clearSearch.addEventListener("click", () => {
    searchInput.value = "";
    searchInput.dispatchEvent(new Event("input"));
  });

  menuButton.addEventListener("click", () => {
    sidebar.classList.add("active");
    menuButton.classList.add("hidden");
    createBackdrop();
    setTimeout(() => searchInput.focus(), 100);
  });

  document.addEventListener("keydown", e => {
    if (e.key === "Escape") closeAll();
  });

  document.addEventListener("click", e => {
    if (sidebar.classList.contains("active") && 
        !sidebar.contains(e.target) && 
        !menuButton.contains(e.target) && 
        !e.target.closest(".suggestion-item")) {
      closeSidebar();
    }
  });

  let touchStartY = 0;
  sidebar.addEventListener("touchstart", e => touchStartY = e.changedTouches[0].screenY, { passive: true });
  sidebar.addEventListener("touchend", e => {
    if (touchStartY - e.changedTouches[0].screenY < -100) closeSidebar();
  }, { passive: true });

  document.getElementById("sidebar-close")?.addEventListener("click", closeSidebar);
  document.getElementById("country-modal-close")?.addEventListener("click", closeCountryModal);
  document.getElementById("group-detail-close")?.addEventListener("click", closeGroupModal);
  document.getElementById("group-detail-back")?.addEventListener("click", closeGroupModal);

  document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      tab.classList.add("active");
      showTabContent(tab.dataset.tab);
    });
  });
}

// ──────────────────────────────────────────────
// Yardımcı Fonksiyonlar
// ──────────────────────────────────────────────

function closeAll() {
  closeSidebar();
  closeCountryModal();
  closeGroupModal();
}

function closeSidebar() {
  sidebar.classList.remove("active");
  menuButton.classList.remove("hidden");
  removeBackdrop();
}

function moveTooltip(e) {
  const rect = mapArea.getBoundingClientRect();
  let x = e.clientX - rect.left + 20;
  let y = e.clientY - rect.top + 20;
  x = Math.max(10, Math.min(x, rect.width - tooltip.offsetWidth - 10));
  y = Math.max(10, Math.min(y, rect.height - tooltip.offsetHeight - 10));
  tooltip.style.left = rect.left + x + "px";
  tooltip.style.top = rect.top + y + "px";
}

function createBackdrop() {
  let b = document.getElementById("sidebar-backdrop");
  if (!b) {
    b = document.createElement("div");
    b.id = "sidebar-backdrop";
    document.body.appendChild(b);
    b.addEventListener("click", closeSidebar);
  }
  setTimeout(() => { b.style.opacity = "1"; b.style.pointerEvents = "all"; }, 30);
}

function removeBackdrop() {
  const b = document.getElementById("sidebar-backdrop");
  if (b) {
    b.style.opacity = "0";
    b.style.pointerEvents = "none";
    setTimeout(() => b.remove(), 400);
  }
}

function clearCountryHighlights() {
  document.querySelectorAll("svg path.highlight-red").forEach(p => p.classList.remove("highlight-red"));
}

function showCountrySuggestions(term) {
  let html = `<h3 style="color:#4ade80; margin:12px 0 8px;">Eşleşen Ülkeler</h3>`;
  const matches = [];

  Object.keys(countryData).forEach(key => {
    const c = countryData[key];
    if ((c.name_tr || key).toLowerCase().includes(term)) {
      matches.push({ id: key, name: c.name_tr || key });
    }
  });

  if (matches.length === 0) {
    html += `<p style="color:#888; padding:12px;">Sonuç yok</p>`;
  } else {
    matches.forEach(m => {
      html += `<div class="suggestion-item" data-id="${m.id}">${m.name}</div>`;
    });
  }

  sidebarContent.innerHTML = html;

  sidebarContent.querySelectorAll(".suggestion-item").forEach(el => {
    el.addEventListener("click", () => {
      activateCountry(el.dataset.id, el.textContent);
      closeSidebar();
    });
  });
}

function showGroupSuggestions(term) {
  const found = new Map();

  Object.values(countryData).forEach(c => {
    if (c.groups) {
      c.groups.forEach(g => {
        const n = (g.name_tr || g.name || "").toLowerCase();
        if (n.includes(term)) {
          const dn = g.name_tr || g.name || "İsimsiz";
          found.set(dn.toLowerCase(), { name: dn, group: g });
        }
      });
    }
  });

  let html = `<h3 style="color:#4ade80; margin:12px 0 8px;">Eşleşen Gruplar</h3>`;

  if (found.size === 0) {
    html += `<p style="color:#888; padding:12px;">Sonuç yok</p>`;
  } else {
    found.forEach(v => {
      html += `<div class="suggestion-item" data-gname="${v.name}">${v.name}</div>`;
    });
  }

  sidebarContent.innerHTML = html;

  sidebarContent.querySelectorAll(".suggestion-item").forEach(el => {
    el.addEventListener("click", () => {
      const name = el.dataset.gname;
      const item = [...found.values()].find(v => v.name === name);
      if (item && item.group) {
        showGroupDetailModal(item.group, "Arama");
        closeSidebar();
      }
    });
  });
}

function showMapByGroupSuggestions(term) {
  const map = {};

  Object.entries(countryData).forEach(([code, c]) => {
    if (c.groups) {
      c.groups.forEach(g => {
        const n = (g.name_tr || g.name || "").toLowerCase();
        if (n.includes(term)) {
          const dn = g.name_tr || g.name || "İsimsiz";
          if (!map[dn]) map[dn] = [];
          map[dn].push({ code, name: c.name_tr || code });
        }
      });
    }
  });

  let html = `<h3 style="color:#4ade80; margin:12px 0 8px;">Gruplar (etkin ülkeler kırmızı)</h3>`;

  const keys = Object.keys(map);
  if (keys.length === 0) {
    html += `<p style="color:#888; padding:12px;">Sonuç yok</p>`;
  } else {
    keys.forEach(k => {
      const arr = map[k];
      html += `
        <div class="suggestion-item" 
             data-codes="${arr.map(o => o.code).join(',')}"
             data-gname="${k}">
          ${k} <small>(${arr.length} ülke)</small>
        </div>`;
    });
  }

  sidebarContent.innerHTML = html;

  sidebarContent.querySelectorAll(".suggestion-item").forEach(el => {
    el.addEventListener("click", () => {
      clearCountryHighlights();
      const codes = el.dataset.codes.split(',');
      codes.forEach(code => {
        const p = document.getElementById(code.trim());
        if (p) p.classList.add("highlight-red");
      });
      // sidebar açık kalsın istersen closeSidebar() satırını kaldır
      // closeSidebar();
    });
  });
}

// ──────────────────────────────────────────────
// Modal Fonksiyonları
// ──────────────────────────────────────────────

function activateCountry(id, name, pathEl = null) {
  if (activePath) activePath.classList.remove("active");
  const target = pathEl || document.getElementById(id);
  if (target) {
    target.classList.add("active");
    activePath = target;
  }
  showCountryModal(id, name);
}

function showCountryModal(id, fallbackName) {
  currentCountryId = id;
  const country = countryData[id] || {};
  const name = country.name_tr || fallbackName;

  document.getElementById("country-modal-title").textContent = name;

  let html = "";
  if (country.groups?.length) {
    country.groups.forEach((g, i) => {
      html += `<div class="group-item" data-idx="${i}">${g.name_tr || g.name || "Bilinmeyen Grup"}</div>`;
    });
  } else {
    html = `<p style="color:#888; text-align:center; padding:40px 0;">Bu ülkede grup bilgisi yok.</p>`;
  }

  document.getElementById("country-groups").innerHTML = html;

  document.querySelectorAll("#country-groups .group-item").forEach(item => {
    item.addEventListener("click", () => {
      const idx = parseInt(item.dataset.idx);
      const group = country.groups[idx];
      if (group) showGroupDetailModal(group, name);
    });
  });

  document.getElementById("country-modal").classList.add("active");
}

function closeCountryModal() {
  document.getElementById("country-modal").classList.remove("active");
  if (activePath) {
    activePath.classList.remove("active");
    activePath = null;
  }
  currentCountryId = null;
}

function showGroupDetailModal(group, countryName) {
  currentGroup = group;
  document.getElementById("group-detail-title").textContent = `${group.name_tr || group.name || "Grup"} (${countryName})`;
  document.querySelector('[data-tab="temel"]').click();
  document.getElementById("group-detail-modal").classList.add("active");
}

function closeGroupModal() {
  document.getElementById("group-detail-modal").classList.remove("active");
  currentGroup = null;
}

function showTabContent(tab) {
  const contentEl = document.getElementById("tab-content");
  if (!currentGroup || !currentGroup.details) {
    contentEl.innerHTML = `<p style="color:#888; text-align:center; padding:50px 0;">Detay yok</p>`;
    return;
  }

  const d = currentGroup.details;

  let html = "";
  if (tab === "temel") {
    html = `
      <p><strong>Kuruluş:</strong> ${d.kurulus_yili || "?"}</p>
      <p><strong>İlk eylem:</strong> ${d.ilk_eylem || "?"}</p>
      <p><strong>Tür:</strong> ${d.grup_turu || "?"}</p>
    `;
  } else if (tab === "durum") {
    html = `<p style="font-size:1.5em; text-align:center; margin:60px 0; color:#4ade80;">${d.grup_durumu || "Bilinmiyor"}</p>`;
  } else if (tab === "detay") {
    document.getElementById("long-detail-modal").classList.add("active");
    html = `<p style="text-align:center; color:#4ade80; padding:80px 0;">Detaylı bilgi büyük modda açıldı.</p>`;
  }

  contentEl.innerHTML = html;
}

</script>
</body>
</html>
